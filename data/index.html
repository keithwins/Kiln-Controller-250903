<!DOCTYPE html>
<html>
<head>
  <title>Kiln Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <h1>Kiln Controller</h1>
  <div class="card">
    <h2>Status</h2>
    <p>Temp 1: <span id="temp1">-</span>°C</p>
    <p>Temp 2: <span id="temp2">-</span>°C</p>
    <p>Average: <span id="avgTemp">-</span>°C</p>
    <p>Setpoint: <span id="setpoint">-</span>°C</p>
    <p>Output: <span id="output">-</span>%</p>
    <p>Status: <span id="status">-</span></p>
  </div>
  <div class="card">
    <h2>Firing Schedule</h2>
    <p>Schedule: <span id="scheduleName">-</span></p>
    <p>Segment: <span id="currentSegment">-</span>/<span id="totalSegments">-</span></p>
    <canvas id="tempChart" width="600" height="300"></canvas>
  </div>
  <div class="card">
    <h2>Control</h2>
    <input type="number" id="setpointInput" placeholder="Enter setpoint (°C)" step="0.1">
    <button onclick="setSetpoint()">Set Setpoint</button>
    <button onclick="start()">Start</button>
    <button onclick="stop()">Stop</button>
    <button class="danger" onclick="emergency()">Emergency Stop</button>
    <button onclick="reset()">Reset</button>
  </div>
  <script>
    let chart;
    function initChart() {
      const ctx = document.getElementById('tempChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [
            { label: 'Temp 1', data: [], borderColor: '#00f', fill: false },
            { label: 'Temp 2', data: [], borderColor: '#0ff', fill: false },
            { label: 'Setpoint', data: [], borderColor: '#f00', fill: false },
            { label: 'Schedule', data: [], borderColor: '#ff0', fill: false, borderDash: [5, 5] }
          ]
        },
        options: {
          scales: {
            x: { type: 'linear', title: { display: true, text: 'Time (s)' } },
            y: { title: { display: true, text: 'Temperature (°C)' }, suggestedMin: 0, suggestedMax: 1300 }
          }
        }
      });
    }
    function updateStatus() {
      fetch('/api/status').then(res => res.json()).then(data => {
        document.getElementById('temp1').innerText = data.temp1.toFixed(1);
        document.getElementById('temp2').innerText = data.temp2.toFixed(1);
        document.getElementById('avgTemp').innerText = data.avgTemp.toFixed(1);
        document.getElementById('setpoint').innerText = data.setpoint.toFixed(1);
        document.getElementById('output').innerText = data.output.toFixed(0);
        document.getElementById('status').innerText = data.emergency ? 'Emergency Stop' : data.enabled ? 'Heating' : 'Ready';
      }).catch(err => console.error('Status fetch error:', err));
    }
    function updateGraph() {
      fetch('/api/data').then(res => res.json()).then(data => {
        const now = Date.now() / 1000;
        chart.data.datasets[0].data = data.data.map(d => ({ x: (d.time / 1000), y: d.temp1 }));
        chart.data.datasets[1].data = data.data.map(d => ({ x: (d.time / 1000), y: d.temp2 }));
        chart.data.datasets[2].data = data.data.map(d => ({ x: (d.time / 1000), y: d.setpoint }));
        chart.update();
      }).catch(err => console.error('Data fetch error:', err));
      fetch('/api/schedule').then(res => res.json()).then(data => {
        document.getElementById('scheduleName').innerText = data.name || 'None';
        document.getElementById('currentSegment').innerText = data.currentSegment + 1;
        document.getElementById('totalSegments').innerText = data.segmentCount;
        chart.data.datasets[3].data = data.points.map(p => ({ x: p.time / 1000, y: p.temp }));
        chart.update();
      }).catch(err => console.error('Schedule fetch error:', err));
    }
    function setSetpoint() {
      const value = document.getElementById('setpointInput').value;
      fetch('/api/setpoint', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
        body: `value=${value}` 
      }).then(res => res.text()).then(alert)
        .catch(err => console.error('Setpoint fetch error:', err));
    }
    function start() { 
      fetch('/api/start', { method: 'POST' }).then(res => res.text()).then(alert)
        .catch(err => console.error('Start fetch error:', err)); 
    }
    function stop() { 
      fetch('/api/stop', { method: 'POST' }).then(res => res.text()).then(alert)
        .catch(err => console.error('Stop fetch error:', err)); 
    }
    function emergency() { 
      fetch('/api/emergency', { method: 'POST' }).then(res => res.text()).then(alert)
        .catch(err => console.error('Emergency fetch error:', err)); 
    }
    function reset() { 
      fetch('/api/reset', { method: 'POST' }).then(res => res.text()).then(alert)
        .catch(err => console.error('Reset fetch error:', err)); 
    }
    initChart();
    setInterval(updateStatus, 5000);
    setInterval(updateGraph, 10000);
    updateStatus();
    updateGraph();
  </script>
</body>
</html>